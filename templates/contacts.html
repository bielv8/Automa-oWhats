{% extends "base.html" %}

{% block title %}Contatos - WhatsApp Automation{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-address-book text-primary me-2"></i>
                Contatos
            </h1>
            <div>
                <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="fas fa-upload me-2"></i>Importar CSV
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
                    <i class="fas fa-plus me-2"></i>Adicionar Contato
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="search" value="{{ search }}" 
                               placeholder="Buscar por nome ou telefone...">
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search me-2"></i>Buscar
                            </button>
                            <a href="{{ url_for('contacts') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Limpar
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Contacts Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if contacts.items %}
                    <div class="table-responsive">
                        <table id="contactsTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Email</th>
                                    <th>Empresa</th>
                                    <th>Criado em</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contact in contacts.items %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="contact_ids" value="{{ contact.id }}" 
                                                   class="form-check-input contact-checkbox">
                                        </td>
                                        <td>
                                            <strong>{{ contact.name }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ contact.phone }}</span>
                                        </td>
                                        <td>{{ contact.email or '-' }}</td>
                                        <td>{{ contact.company or '-' }}</td>
                                        <td>
                                            <small class="text-muted">
                                                {{ contact.created_at.strftime('%d/%m/%Y %H:%M') }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-warning" onclick="editContact({{ contact.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteContact({{ contact.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if contacts.pages > 1 %}
                        <nav aria-label="Pagination">
                            <ul class="pagination justify-content-center">
                                {% if contacts.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('contacts', page=contacts.prev_num, search=search) }}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for page_num in contacts.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != contacts.page %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('contacts', page=page_num, search=search) }}">
                                                    {{ page_num }}
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page_num }}</span>
                                            </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if contacts.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('contacts', page=contacts.next_num, search=search) }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}

                    <!-- Bulk Actions -->
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    Mostrando {{ contacts.items|length }} de {{ contacts.total }} contatos
                                </small>
                            </div>
                            <div class="col-md-6 text-end">
                                <button id="bulkActionsBtn" class="btn btn-outline-primary" disabled>
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Criar Campanha com Selecionados
                                </button>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-address-book fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum contato encontrado</h5>
                        <p class="text-muted">Adicione contatos manualmente ou importe um arquivo CSV</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
                            <i class="fas fa-plus me-2"></i>Adicionar Primeiro Contato
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Adicionar Contato
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_contact') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Nome *</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Telefone *</label>
                        <input type="tel" class="form-control" id="phone" name="phone" 
                               placeholder="11999999999" required>
                        <div class="form-text">
                            Digite apenas números (com ou sem código do país)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="company" class="form-label">Empresa</label>
                        <input type="text" class="form-control" id="company" name="company">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Importar Contatos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('import_contacts') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="file" class="form-label">Arquivo CSV</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                    </div>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Formato do CSV:</h6>
                        <p class="mb-1"><strong>Colunas obrigatórias:</strong> nome, telefone</p>
                        <p class="mb-1"><strong>Colunas opcionais:</strong> email, empresa</p>
                        <hr>
                        <small>
                            <strong>Exemplo:</strong><br>
                            <code>nome,telefone,email,empresa<br>
                            João Silva,11999999999,joao@email.com,Empresa ABC</code>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Importar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    if ($('#contactsTable').length) {
        $('#contactsTable').DataTable({
            "paging": false,
            "searching": false,
            "info": false,
            "ordering": true,
            "columnDefs": [
                { "orderable": false, "targets": [0, 6] }
            ]
        });
    }

    // Select all checkbox functionality
    $('#selectAll').change(function() {
        $('.contact-checkbox').prop('checked', this.checked);
        updateBulkActions();
    });

    // Individual checkbox functionality
    $('.contact-checkbox').change(function() {
        updateBulkActions();
        
        // Update select all checkbox
        const total = $('.contact-checkbox').length;
        const checked = $('.contact-checkbox:checked').length;
        $('#selectAll').prop('indeterminate', checked > 0 && checked < total);
        $('#selectAll').prop('checked', checked === total);
    });

    function updateBulkActions() {
        const selectedCount = $('.contact-checkbox:checked').length;
        $('#bulkActionsBtn').prop('disabled', selectedCount === 0);
        
        if (selectedCount > 0) {
            $('#bulkActionsBtn').html(`<i class="fas fa-paper-plane me-2"></i>Criar Campanha com ${selectedCount} Selecionados`);
        } else {
            $('#bulkActionsBtn').html('<i class="fas fa-paper-plane me-2"></i>Criar Campanha com Selecionados');
        }
    }

    // Bulk actions button
    $('#bulkActionsBtn').click(function() {
        const selectedIds = $('.contact-checkbox:checked').map(function() {
            return this.value;
        }).get();
        
        if (selectedIds.length > 0) {
            // Redirect to campaigns page with selected contacts
            const params = selectedIds.map(id => `contact_ids=${id}`).join('&');
            window.location.href = `/campaigns?${params}`;
        }
    });
});

function editContact(contactId) {
    // TODO: Implement edit functionality
    alert('Funcionalidade de edição será implementada em breve');
}

function deleteContact(contactId) {
    if (confirm('Tem certeza que deseja excluir este contato?')) {
        // TODO: Implement delete functionality
        alert('Funcionalidade de exclusão será implementada em breve');
    }
}
</script>
{% endblock %}
