{% extends "base.html" %}

{% block title %}Templates - WhatsApp Automation{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-file-alt text-primary me-2"></i>
                Templates de Mensagem
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTemplateModal">
                <i class="fas fa-plus me-2"></i>Novo Template
            </button>
        </div>
    </div>
</div>

<!-- Templates Grid -->
<div class="row">
    {% if templates %}
        {% for template in templates %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">{{ template.name }}</h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="editTemplate({{ template.id }})">
                                        <i class="fas fa-edit me-2"></i>Editar
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="duplicateTemplate({{ template.id }})">
                                        <i class="fas fa-copy me-2"></i>Duplicar
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" onclick="deleteTemplate({{ template.id }})">
                                        <i class="fas fa-trash me-2"></i>Excluir
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if template.subject %}
                            <p class="text-muted mb-2">
                                <strong>Assunto:</strong> {{ template.subject }}
                            </p>
                        {% endif %}
                        
                        <div class="template-preview">
                            <p class="card-text">{{ template.content[:100] }}{% if template.content|length > 100 %}...{% endif %}</p>
                        </div>
                        
                        {% set variables = template.variables|from_json if template.variables else [] %}
                        {% if variables %}
                            <div class="mt-3">
                                <small class="text-muted d-block mb-2">Variáveis:</small>
                                {% for variable in variables %}
                                    <span class="badge bg-info me-1">{{"{{"}}{{ variable }}{{"}}"}}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                {{ template.created_at.strftime('%d/%m/%Y') }}
                            </small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="previewTemplate({{ template.id }})">
                                    <i class="fas fa-eye me-1"></i>Preview
                                </button>
                                <button class="btn btn-outline-success" onclick="useTemplate({{ template.id }})">
                                    <i class="fas fa-paper-plane me-1"></i>Usar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum template encontrado</h5>
                    <p class="text-muted">Crie seu primeiro template de mensagem para começar</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTemplateModal">
                        <i class="fas fa-plus me-2"></i>Criar Primeiro Template
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Add Template Modal -->
<div class="modal fade" id="addTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-plus me-2"></i>Novo Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_template') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Nome do Template *</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subject" class="form-label">Assunto (opcional)</label>
                        <input type="text" class="form-control" id="subject" name="subject">
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">Conteúdo da Mensagem *</label>
                        <textarea class="form-control" id="content" name="content" rows="8" required 
                                placeholder="Digite sua mensagem aqui...&#10;&#10;Use variáveis como:&#10;{{nome}} - Nome do contato&#10;{{empresa}} - Empresa do contato&#10;{{telefone}} - Telefone do contato&#10;{{email}} - Email do contato"></textarea>
                        
                        <div class="form-text">
                            <strong>Variáveis disponíveis:</strong><br>
                            <code>{{nome}}</code>, <code>{{telefone}}</code>, <code>{{email}}</code>, <code>{{empresa}}</code>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Preview da Mensagem</label>
                        <div id="messagePreview" class="border rounded p-3 bg-light text-dark">
                            <em class="text-muted">Digite o conteúdo para ver o preview...</em>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Dicas:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Use variáveis para personalizar mensagens automaticamente</li>
                            <li>Mantenha mensagens concisas e objetivas</li>
                            <li>Teste o template antes de usar em campanhas</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar Template
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Template Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Preview do Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Como aparecerá para o contato:</label>
                    <div id="templatePreviewContent" class="border rounded p-3 bg-light text-dark">
                        <!-- Preview content will be inserted here -->
                    </div>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    As variáveis serão substituídas pelos dados reais do contato durante o envio.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Real-time preview while typing
    $('#content').on('input', function() {
        updatePreview();
    });
    
    function updatePreview() {
        const content = $('#content').val();
        if (content.trim() === '') {
            $('#messagePreview').html('<em class="text-muted">Digite o conteúdo para ver o preview...</em>');
            return;
        }
        
        // Replace variables with sample data for preview
        let preview = content
            .replace(/\{\{nome\}\}/g, '<span class="text-primary fw-bold">João Silva</span>')
            .replace(/\{\{telefone\}\}/g, '<span class="text-info">11 99999-9999</span>')
            .replace(/\{\{email\}\}/g, '<span class="text-info">joao@email.com</span>')
            .replace(/\{\{empresa\}\}/g, '<span class="text-warning">Empresa ABC</span>');
        
        // Convert line breaks to HTML
        preview = preview.replace(/\n/g, '<br>');
        
        $('#messagePreview').html(preview);
    }
});

function editTemplate(templateId) {
    // TODO: Implement edit functionality
    alert('Funcionalidade de edição será implementada em breve');
}

function duplicateTemplate(templateId) {
    // TODO: Implement duplicate functionality
    alert('Funcionalidade de duplicação será implementada em breve');
}

function deleteTemplate(templateId) {
    if (confirm('Tem certeza que deseja excluir este template?')) {
        // TODO: Implement delete functionality
        alert('Funcionalidade de exclusão será implementada em breve');
    }
}

function previewTemplate(templateId) {
    // TODO: Load template data and show preview
    // For now, show a simple preview
    $('#templatePreviewContent').html(`
        <p><strong>Olá, João Silva!</strong></p>
        <p>Esta é uma mensagem de demonstração do template.</p>
        <p>Empresa: Empresa ABC<br>
        Telefone: 11 99999-9999</p>
        <p>Atenciosamente,<br>
        Equipe WhatsApp Automation</p>
    `);
    
    $('#previewModal').modal('show');
}

function useTemplate(templateId) {
    // Redirect to campaigns page with selected template
    window.location.href = `/campaigns?template_id=${templateId}`;
}

// Add filter functionality for templates by name/content search
</script>
{% endblock %}
